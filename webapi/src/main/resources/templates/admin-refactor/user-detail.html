<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="content">
    <div class="row d-flex">
        <div class="col-lg-3 col-xlg-4 col-md-5">
            <div class="card">
                <div class="card-body">
                    <div class="m-t-30 text-center"> <img th:src="${user.avatar}" class="img-circle" alt="Ảnh đại diện"
                                                          width="150">
                        <h4 class="card-title m-t-10 mt-2" th:text="${user.fullname}">Cao Tiến</h4>
                        <h6 class="card-subtitle" th:text="${@thymeleafHelper.convertRole(user.role.role)}">Photographer</h6>
                    </div>
                </div>
                <hr>
                <div>
                    <p class="d-inline p-2 font-weight-bold ml-2">Số đơn hẹn:</p>
                    <p class="d-inline p-2" th:text="${bookingInfo.numOfBooking}">12</p>
                </div>
                <div>
                    <p class="d-inline p-2 font-weight-bold ml-2">Hoàn thành:</p>
                    <p class="d-inline p-2" th:text="${bookingInfo.numOfDone}">10</p>
                </div>
                <div>
                    <p class="d-inline p-2 font-weight-bold ml-2">Hủy:</p>
                    <p class="d-inline p-2" th:text="${bookingInfo.numOfCancelled}">2</p>
                </div>
                <div>
                    <p class="d-inline p-2 font-weight-bold ml-2">Tỉ lệ hủy hẹn:</p>
                    <p class="d-inline p-2" th:text="${bookingInfo.cancellationRate} + '%'">15%</p>
                </div>
                <div>
                    <hr>
                </div>
                <div class="card-body"> <small class="text-muted">Email </small>
                    <h6 th:text="${user.email}">caotien@gmail.com</h6> <small class="text-muted p-t-30 db">Số điện thoại</small>
                    <h6 th:text="${user.phone}">0903917982</h6>
                </div>
                <div class="divider"></div>
                <div class="card-body text-center">
                    <h6 class="font-weight-bold">Trạng thái tài khoản</h6>
                    <h6 class="badge badge-warning" th:if="${user.isBlocked==true}">Đã bị chặn</h6>
                    <h6 class="badge badge-warning" th:if="${user.isEnabled==false}">Chưa kích hoạt</h6>
                    <h6 class="badge badge-info" th:if="${user.isEnabled==true && user.isBlocked==false}">Bình thường</h6>
                </div>
                <div class="divider"></div>
                <div class="text-center form-inline align-items-center justify-content-center">
                    <form id="block-form" method="post" class="mb-2 text-center">
                        <button th:if="${user.isBlocked==false}" class="btn btn-danger" type="submit">Chặn</button>
                    </form>
                    <form id="unblock-form" class="mb-2 text-center">
                        <button th:if="${user.isBlocked==true}" class="btn btn-success" type="submit">Gỡ chặn</button>
                    </form>
                    <form id="enable-form" class="mb-2 text-center">
                        <button th:if="${user.isEnabled==false}" class="btn btn-success" type="submit">Kích hoạt tài khoản</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="main-card mb-3 card">
                <div class="card-header"><div th:text="'Lịch hẹn của ' + ${user.fullname}">Lịch hẹn của Cao Tiến</div>
                    <div class="btn-actions-pane-right">
                        <div id="reportrange-userdetail" class="mb-2 mr-2 dropdown-toggle btn btn-outline-info">
                            <i class="fa fa-calendar"></i>&nbsp;
                            <span></span> <i class="fa fa-caret-down"></i>
                        </div>
                        <!-- <input class="mb-2 mr-2 dropdown-toggle btn btn-outline-info" name="dates"/> -->
                        <div role="group" class="btn-group-sm btn-group">
                            <a style="display: none;" id="userdetail-date" th:href="@{/admin/v2/users/{userId}(userId=${user.id},page=${page.number},size=${size})}">10 kết quả</a>
                            <button type="button" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown"
                                    class="mb-2 mr-2 dropdown-toggle btn btn-outline-info">Trạng thái</button>
                            <div tabindex="-1" role="menu" aria-hidden="true" class="dropdown-menu">
                                <a th:classappend="${status} == 'ALL' ? disabled : ''" onclick="filterStatusAll()" tabindex="-1" class="dropdown-item">Tất cả</a>
                                <a th:classappend="${status} == 'PENDING' ? disabled : ''" onclick="filterStatusPending()" tabindex="0" class="dropdown-item">Chờ xác nhận</a>
                                <a th:classappend="${status} == 'ONGOING' ? disabled : ''" onclick="filterStatusOngoing()" tabindex="0" class="dropdown-item">Sắp diễn ra</a>
                                <a th:classappend="${status} == 'CANCELLED' ? disabled : ''" onclick="filterStatusCancelled()" tabindex="0" class="dropdown-item">Đã hủy</a>
                                <a th:classappend="${status} == 'DONE' ? disabled : ''" onclick="filterStatusDone()" tabindex="0" class="dropdown-item">Đã hoàn thành</a>
                                <a th:classappend="${status} == 'REJECTED' ? disabled : ''" onclick="filterStatusRejected()" tabindex="0" class="dropdown-item">Đã từ chối</a>
                            </div>
                        </div>
                        <div role="group" class="btn-group-sm btn-group dropdown-menu-left">
                            <button type="button" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown"
                                    class="mb-2 mr-2 dropdown-toggle btn btn-outline-info"></button>
                            <div tabindex="-1" role="menu" aria-hidden="true" class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" th:classappend="${size} == 10 ? disabled : ''" tabindex="-1" onclick="limitRecord10()">10 kết quả</a>
                                <a class="dropdown-item" th:classappend="${size} == 20 ? disabled : ''" tabindex="0" onclick="limitRecord20()">20 kết quả</a>
                                <a class="dropdown-item" th:classappend="${size} == 50 ? disabled : ''" tabindex="0" onclick="limitRecord50()">50 kết quả</a>
                                <a class="dropdown-item" th:classappend="${size} == 1000 ? disabled : ''" tabindex="0" onclick="limitRecordAll()">Tất cả</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="align-middle mb-0 table table-borderless table-striped table-hover">
                        <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th>Khách hàng</th>
                            <th class="text-center">Thời gian hẹn</th>
                            <th class="text-center">Thợ chụp</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Tác vụ</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="booking: ${page.content}">
                            <td class="text-center text-muted" th:text="${booking.id}">#345</td>
                            <td>
                                <div class="widget-content p-0">
                                    <div class="widget-content-wrapper">
                                        <div class="widget-content-left mr-3">
                                            <div class="widget-content-left">
                                                <img width="40" class="rounded-circle" th:src="${booking.customer.avatar}"
                                                     alt="">
                                            </div>
                                        </div>
                                        <div class="widget-content-left flex2">
                                            <div class="widget-heading" th:text="${booking.customer.fullname}">Uyển Nhi</div>
                                        </div>
                                    </div>
                                </div>
                </td>
                <td class="text-center" th:text="${#dates.format(booking.timeLocationDetails.get(0).start, 'HH:mm dd-MM-yyyy')}">08:00 12/20/2020</td>
                <td>
                    <div class="widget-content p-0">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left mr-3">
                                <div class="widget-content-left">
                                    <img width="40" class="rounded-circle" th:src="${booking.photographer.avatar}" alt="">
                                </div>
                            </div>
                            <div class="widget-content-left flex2">
                                <div class="widget-heading" th:text="${booking.photographer.fullname}">Cao Tiến</div>
                            </div>
                        </div>
                    </div>
            </td>
            <td class="text-center">
                <div class="badge badge-warning" th:text="${booking.bookingStatus}">Chờ xác nhận</div>
            </td>
            <td class="text-center">
                <a th:onclick="'toBookingDetail('+ ${booking.id} +')'" id="PopoverCustomT-1" class="btn btn-primary btn-sm text-white">Chi tiết</a>
            </td>
            </tr>
            </tbody>
            </table>
        </div>
        <div class="d-block text-center card-footer">
            <nav aria-label="..." class="d-flex justify-content-center">
                <ul class="pagination pagination-sm">
                    <li th:if="${page.hasPrevious()}" class="page-item"><a id="user-booking-list-a-paging-previous">Trước</a></li>
                    <th:block th:each="i: ${#numbers.sequence(0, page.totalPages - 1)}">
                        <li class="page-item"><span class="page-link disabled" th:if="${page.number == i}">[[${i}+1]]</span></li>
                        <li th:unless="${page.number == i}" class="page-item"><a onclick="toPage(this)">[[${i}+1]]</a></li>
                    </th:block>
                    <li th:if="${page.hasNext()}" class="page-item"><a id="user-booking-list-a-paging-next">Sau</a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>
</div>

    <script th:inline="javascript">

        $('#block-form').submit((e) => {
            e.preventDefault();
            const userId = [[${user.id}]]
            $.ajax({
                type:"post",
                url: '/admin/v2/users/' + userId + '/block',
                success: function(result){
                    $('#admin-content').load('/admin/v2/users/' + userId);
                }
            });
        });

        $('#unblock-form').submit((e) => {
            e.preventDefault();
            const userId = [[${user.id}]]
            $.ajax({
                type:"post",
                url: '/admin/v2/users/' + userId + '/unblock',
                success: function(result){
                    $('#admin-content').load('/admin/v2/users/' + userId);
                }
            });
        });

        $('#enable-form').submit((e) => {
            e.preventDefault();
            const userId = [[${user.id}]]
            $.ajax({
                type:"post",
                url: '/admin/v2/users/' + userId + '/enable',
                success: function(result){
                    $('#admin-content').load('/admin/v2/users/' + userId);
                }
            });
        });

        var userId = [[${user.id}]];

        function toBookingDetail(bookingId) {
            $('#admin-content').load('/admin/bookings/' + bookingId);
        }

        function limitRecord10() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?'  + $.param({size: 10, page: [[${page.number}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
        }

        function limitRecord20() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: 20, page: [[${page.number}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
        }

        function limitRecord50() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: 50, page: [[${page.number}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
        }

        function limitRecordAll() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: 1000, page: [[${page.number}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
        }

        function filterStatusAll() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'ALL'}));
        }

        function filterStatusPending() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'PENDING'}));
        }

        function filterStatusOngoing() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'Ongoing'}));
        }

        function filterStatusCancelled() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'CANCELLED'}));
        }

        function filterStatusDone() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'DONE'}));
        }

        function filterStatusRejected() {
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: 0, start:[[${start}]], end: [[${end}]], status: 'REJECTED'}));
        }

        // th:href="@{/admin/v2/users(page=${i},size=${page.size})}"

        function toPage(atag) {
            let page = atag.text;
            page = page - 1;
            $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: page, start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
        }

        $(document).ready(()=>{
            $('#user-booking-list-a-paging-previous').click(() => {
                $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: [[${page.number - 1}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
            });

            // $('.numm').click(() => {
            //     alert($(this).text());
            //     $('#admin-content').load('/admin/v2/users?'  + $.param({size: [[${page.size}]], page: 1}));
            // });

            $('#user-booking-list-a-paging-next').click(() => {
                $('#admin-content').load('/admin/v2/users/' + userId + '?' + $.param({size: [[${page.size}]], page: [[${page.number + 1}]], start:[[${start}]], end: [[${end}]], status: [[${status}]]}));
            });
        });
    </script>

    <script th:inline="javascript">

        moment.locale('vi', {
            months: 'Tháng 1_Tháng 2_Tháng 3_Tháng 4_Tháng 5_Tháng 6_Tháng 7_Tháng 8_Tháng 9_Tháng 10_Tháng 11_Tháng 12'.split('_'),
            monthsShort: 'T1._T2._T3_T4._T5_T6_T7._T8_T9._T10._T11._T12.'.split('_'),
            monthsParseExact: true,
            weekdays: 'Chủ nhật_Thứ 2_Thứ 3_Thứ 4 _Thứ 5_Thứ 6_Thứ 7'.split('_'),
            weekdaysShort: 'CN._T2._T3._T4._T5._T6._T7.'.split('_'),
            weekdaysMin: 'CN_T2_T3_T4_T5_T6_T7'.split('_'),
            weekdaysParseExact: true,
            longDateFormat: {
                LT: 'HH:mm',
                LTS: 'HH:mm:ss',
                L: 'DD/MM/YYYY',
                LL: 'D MMMM YYYY',
                LLL: 'D MMMM YYYY HH:mm',
                LLLL: 'dddd D MMMM YYYY HH:mm'
            },
            calendar: {
                sameDay: '[Ngày hôm nay] LT',
                nextDay: '[Ngày mai] LT',
                nextWeek: 'dddd [Tuần tới] LT',
                lastDay: '[Hôm qua] LT',
                lastWeek: 'dddd [Tuần trước] LT',
                sameElse: 'L'
            },
            relativeTime: {
                future: 'Lúc %s',
                past: '%s',
                s: 'Vài giây',
                m: 'Vài phút',
                mm: '%d phút',
                h: 'Giờ',
                hh: '%d giờ',
                d: 'Ngày',
                dd: 'Ngày %d',
                M: 'Tháng',
                MM: 'Tháng %d',
                y: 'Năm',
                yy: 'Năm %d'
            },
            dayOfMonthOrdinalParse: /\d{1,2}(er|e)/,
            ordinal: function (number) {
                return number + (number === 1 ? 'er' : 'e');
            },
            meridiemParse: /PD|MD/,
            isPM: function (input) {
                return input.charAt(0) === 'M';
            },
            // In case the meridiem units are not separated around 12, then implement
            // this function (look at locale/id.js for an example).
            // meridiemHour : function (hour, meridiem) {
            //     return /* 0-23 hour, given meridiem token and hour 1-12 */ ;
            // },
            meridiem: function (hours, minutes, isLower) {
                return hours < 12 ? 'PD' : 'MD';
            },
            week: {
                dow: 1, // Monday is the first day of the week.
                doy: 4  // Used to determine first week of the year.
            }
        });

        $(function () {

            // var start = moment().subtract(29, 'days');
            // var end = moment();
            var start = new Date([[${start}]]);
            var end = new Date([[${end}]]);

            function cb(start, end) {
                if(start.toString().localeCompare('Invalid date')) {
                    $('#reportrange-userdetail span').html(formatDate(start) + ' - ' + formatDate(end));
                } else {
                    $('#reportrange-userdetail span').html('Tất cả');
                }
            }

            $('#reportrange-userdetail').daterangepicker({
                startDate: isValidDate(start) ? start : moment(),
                endDate: isValidDate(end) ? end : moment(),
                ranges: {
                    'Tất cả': ['', ''],
                    'Hôm nay': [moment(), moment()],
                    'Hôm qua': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    '7 Ngày trước': [moment().subtract(6, 'days'), moment()],
                    '30 Ngày trước': [moment().subtract(29, 'days'), moment()],
                    'Tháng này': [moment().startOf('month'), moment().endOf('month')],
                    'Tháng trước': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }

            }, cb);

            cb(start, end);
            if(!isValidDate(start)) {
                $('#reportrange-userdetail span').html('Tất cả');
            }
            $(".applyBtn").text("Chọn");
            $(".cancelBtn").text("Hủy");
            $('*[data-range-key="Custom Range"]').text("Tùy chỉnh");

        });

        $('#reportrange-userdetail').on('apply.daterangepicker', function(ev, picker) {
            var startDate = $('#reportrange-userdetail').data('daterangepicker').startDate._d;
            var endDate = $('#reportrange-userdetail').data('daterangepicker').endDate._d;
            if(isValidDate(startDate)) {
                let status = [[${status}]];
                $('#admin-content').load(document.getElementById('userdetail-date').href + `&start=${formatDate(startDate)}&end=${formatDate(endDate)}&status=` + status.toString());
            } else {
                let status = [[${status}]];
                $('#admin-content').load(document.getElementById('userdetail-date').href + `&status=` + status.toString());
            }
        });

        function isValidDate(d) {
            return d instanceof Date && !isNaN(d);
        }

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-');
        }

        // $('input[name="dates"]').daterangepicker();
    </script>
</div>
</html>